---
title: "R Notebook"
output:
  html_document:
    df_print: paged
runtime: shiny
---

Let's illustrate a pretty useful method to model periodic series: generating artifitial fourier series to capture the cycles and sub-cycles on a periodic time series
```{r}
source('/Users/ssobrinou/IE/Advanced/2019_Advanced/Regression/code/load_libraries.R')

data("AirPassengers")
plot(AirPassengers); grid()

y<-copy(AirPassengers)

```

The stl decomposition method from the forecast package show's us a de-composition of our series onto trend, seasonality (cycle) and irregular
```{r}
library(forecast)

str(y)
frequency(y)

# stl function for time series de-composiong

decomp<-stl(y, s.window = 12)
plot(decomp); grid()
```

The fourier function generates k-pairs of fourier transformations based on the dependent variable time frecuency
```{r}
# creating fourier series of different amplitude

forecast::fourier(y,K=4)

df<-data.table(y=y,
               fourier(y,K=2))
head(df)

colnames(df)<-gsub('-','_',colnames(df))
```


Actualy, fouriers series are just sin and cosine functions for 1, 2...k amplitude of a simple function
```{r}

t=seq(1,12)
N=12

c1<-cos(2*pi*t/N)
s1<-sin(2*pi*t/N)

c2<-cos(2*2*pi*t/N)
s2<-sin(2*2*pi*t/N)

identical(round(c1,4), round(df$C1_12[1:12],4))
identical(round(s1,4), round(df$S1_12[1:12],4))
identical(round(c2,4), round(df$C2_12[1:12],4))
identical(round(s2,4), round(df$S2_12[1:12],4))

```


```{r}
par(mfrow=c(1,2))
plot(c1, type='b', main='1st & 2nd Sin Wave'); grid()
lines(c2, type='b', col='blue')
plot(s1, type='b', main='1st & 2nd Sin Wave'); grid()
lines(s2, type='b',  col='blue')
par(mfrow=c(1,1))
```


```{r}
df[, tend:=seq(1,nrow(df))]

lm_fourier<-lm(log(y)~., data=df)
summary(lm_fourier)  

plot(as.numeric(y), type='l'); grid()
lines(exp(fitted(lm_fourier)), col='red')
```

```{r, echo=FALSE}
library(shiny)
shinyApp(
  
  ui = fluidPage(
    sliderInput(label="Number of Fourier Series",
                inputId =  "k",
                min=1,
                max=12,
                value=1,
                step=1),
    plotOutput("fitplot")
  ),
  
  server = function(input, output) {
    output$fitplot = renderPlot({
      
      # calculate fourier series varying with k input (and a fixed linear trend)
      df<-data.table(y=as.numeric(AirPassengers),
               fourier(y,K=input$k))
      df[, tend:=seq(1,nrow(df))]
      # estimate model
      lm_fourier<-lm(log(y)~., data=df)
      
      # plot fit
      plot(as.numeric(y), type='l'); grid()
      lines(exp(fitted(lm_fourier)), col='red')
    })
  },
  
  options = list(height = 500)
)
```



